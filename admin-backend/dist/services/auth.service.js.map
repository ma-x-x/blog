{"version":3,"sources":["../../src/services/auth.service.ts"],"sourcesContent":["import { compare, hash } from 'bcrypt';\nimport { sign } from 'jsonwebtoken';\nimport { SECRET_KEY } from '@config';\nimport DB from '@databases';\nimport { CreateUserDto, LoginUserDto } from '@dtos/users.dto';\nimport { HttpException } from '@exceptions/HttpException';\nimport { DataStoredInToken, TokenData } from '@interfaces/auth.interface';\nimport { User } from '@interfaces/users.interface';\nimport { isEmpty } from '@utils/util';\nimport { EXPIRES_IN } from '@/config';\n\nclass AuthService {\n  public users = DB.Users;\n\n  public async signup(userData: CreateUserDto): Promise<User> {\n    if (isEmpty(userData)) throw new HttpException(400, '请求参数错误!');\n    for (let item in userData) {\n      if (!userData[item]) {\n        throw new HttpException(400, `参数${item}不能为空！`);\n      }\n    }\n\n    const findUserById: User = await this.users.findOne({\n      where: { username: userData.username },\n    });\n\n    if (findUserById) throw new HttpException(409, `用户名已存在`);\n\n    const findUserByEmail: User = await this.users.findOne({\n      where: { email: userData.email },\n    });\n\n    if (findUserByEmail) throw new HttpException(409, `邮箱已存在`);\n\n    const hashedPassword = await hash(userData.password, 10);\n    const createUserData: User = await this.users.create({\n      ...userData,\n      password: hashedPassword,\n    });\n\n    return createUserData;\n  }\n\n  public async login(userData: LoginUserDto): Promise<{ cookie: string; token: string; findUser: User }> {\n    if (isEmpty(userData)) throw new HttpException(400, '用户名和密码不得为空');\n\n    const findUser: User = await this.users.findOne({\n      where: { username: userData.username },\n    });\n\n    if (!findUser) throw new HttpException(409, `用户名不存在`);\n\n    const isPasswordMatching: boolean = await compare(userData.password, findUser.password);\n    if (!isPasswordMatching) throw new HttpException(409, '用户名或密码不匹配');\n\n    const tokenData = this.createToken(findUser);\n    const cookie = this.createCookie(tokenData);\n\n    return { token: tokenData.token, cookie, findUser };\n  }\n\n  public async logout(userData: User): Promise<User> {\n    if (isEmpty(userData)) throw new HttpException(400, \"You're not userData\");\n\n    const findUser: User = await this.users.findOne({\n      where: { username: userData.username, password: userData.password },\n    });\n    if (!findUser) throw new HttpException(409, \"You're not user\");\n\n    return findUser;\n  }\n\n  public createToken(user: User): TokenData {\n    const dataStoredInToken: DataStoredInToken = { id: user.id, username: user.username };\n    const secretKey: string = SECRET_KEY;\n    const expiresIn: number = Number(EXPIRES_IN) ?? 60 * 60;\n\n    return {\n      expiresIn,\n      token: sign(dataStoredInToken, secretKey, { expiresIn }),\n    };\n  }\n\n  public createCookie(tokenData: TokenData): string {\n    return `Authorization=${tokenData.token}; HttpOnly; Max-Age=${tokenData.expiresIn};`;\n  }\n}\n\nexport default AuthService;\n"],"names":["AuthService","signup","userData","isEmpty","HttpException","item","findUserById","users","findOne","where","username","findUserByEmail","email","hashedPassword","hash","password","createUserData","create","login","findUser","isPasswordMatching","compare","tokenData","createToken","cookie","createCookie","token","logout","user","dataStoredInToken","id","secretKey","SECRET_KEY","Number","expiresIn","EXPIRES_IN","sign","DB","Users"],"mappings":"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"}