{"version":3,"sources":["../../src/middlewares/auth.middleware.ts"],"sourcesContent":["import { NextFunction, Response } from 'express';\nimport { verify } from 'jsonwebtoken';\nimport { SECRET_KEY } from '@config';\nimport DB from '@databases';\nimport { HttpException } from '@exceptions/HttpException';\nimport { DataStoredInToken, RequestWithUser } from '@interfaces/auth.interface';\n\nconst authMiddleware = async (\n  req: RequestWithUser,\n  res: Response,\n  next: NextFunction,\n) => {\n  try {\n    const Authorization =\n      req.cookies['Authorization'] ||\n      (req.header('Authorization')\n        ? req.header('Authorization').split('Bearer ')[1]\n        : null);\n\n    if (Authorization) {\n      const secretKey: string = SECRET_KEY;\n      const verificationResponse = verify(\n        Authorization,\n        secretKey,\n      ) as DataStoredInToken;\n      const username = verificationResponse.id;\n      const findUser = await DB.Users.findByPk(username);\n\n      if (findUser) {\n        req.user = findUser;\n        next();\n      } else {\n        next(new HttpException(401, 'Wrong authentication token'));\n      }\n    } else {\n      next(new HttpException(404, 'Authentication token missing'));\n    }\n  } catch (error) {\n    next(new HttpException(401, 'Wrong authentication token'));\n  }\n};\n\nexport default authMiddleware;\n"],"names":["authMiddleware","req","res","next","Authorization","cookies","header","split","secretKey","SECRET_KEY","verificationResponse","verify","username","id","findUser","DB","Users","findByPk","user","HttpException","error"],"mappings":"AAAA;;;;;AACuB,IAAA,aAAc,WAAd,cAAc,CAAA;AACV,IAAA,OAAS,WAAT,WAAS,CAAA;AACrB,IAAA,UAAY,kCAAZ,cAAY,EAAA;AACG,IAAA,cAA2B,WAA3B,6BAA2B,CAAA;;;;;;AAGzD,MAAMA,cAAc,GAAG,OACrBC,GAAoB,EACpBC,GAAa,EACbC,IAAkB,GACf;IACH,IAAI;QACF,MAAMC,aAAa,GACjBH,GAAG,CAACI,OAAO,CAAC,eAAe,CAAC,IAC5B,CAACJ,GAAG,CAACK,MAAM,CAAC,eAAe,CAAC,GACxBL,GAAG,CAACK,MAAM,CAAC,eAAe,CAAC,CAACC,KAAK,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,GAC/C,IAAI,CAAC,AAAC;QAEZ,IAAIH,aAAa,EAAE;YACjB,MAAMI,SAAS,GAAWC,OAAU,WAAA,AAAC;YACrC,MAAMC,oBAAoB,GAAGC,CAAAA,GAAAA,aAAM,AAGlC,CAAA,OAHkC,CACjCP,aAAa,EACbI,SAAS,CACV,AAAqB,AAAC;YACvB,MAAMI,QAAQ,GAAGF,oBAAoB,CAACG,EAAE,AAAC;YACzC,MAAMC,QAAQ,GAAG,MAAMC,UAAE,QAAA,CAACC,KAAK,CAACC,QAAQ,CAACL,QAAQ,CAAC,AAAC;YAEnD,IAAIE,QAAQ,EAAE;gBACZb,GAAG,CAACiB,IAAI,GAAGJ,QAAQ,CAAC;gBACpBX,IAAI,EAAE,CAAC;aACR,MAAM;gBACLA,IAAI,CAAC,IAAIgB,cAAa,cAAA,CAAC,GAAG,EAAE,4BAA4B,CAAC,CAAC,CAAC;aAC5D;SACF,MAAM;YACLhB,IAAI,CAAC,IAAIgB,cAAa,cAAA,CAAC,GAAG,EAAE,8BAA8B,CAAC,CAAC,CAAC;SAC9D;KACF,CAAC,OAAOC,KAAK,EAAE;QACdjB,IAAI,CAAC,IAAIgB,cAAa,cAAA,CAAC,GAAG,EAAE,4BAA4B,CAAC,CAAC,CAAC;KAC5D;CACF,AAAC;eAEanB,cAAc"}