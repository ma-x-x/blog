{"version":3,"sources":["../../src/middlewares/auth.jwtToken.ts"],"sourcesContent":["import jwt from 'jsonwebtoken';\nimport { SECRET_KEY } from '@config';\nimport { Response } from 'express';\nimport { NextFunction } from 'express';\nimport { HttpException } from '@/exceptions/HttpException';\nimport { RequestWithUser } from '@/interfaces/auth.interface';\nimport { User } from '@interfaces/users.interface';\n\nexport const jwtUnlessPath = ['/login', '/signup'];\n\n/**\n * 判断token是否可用\n */\nexport default function () {\n  return async function jwtTokenParse(req: RequestWithUser, res: Response, next: NextFunction) {\n    // 检测过滤的路由就不做解析JWT了\n    if (jwtUnlessPath.find(item => item === req.url)) {\n      await next();\n      return false;\n    }\n\n    // 获取jwt\n    const token = req.header('authorization');\n    if (!token) {\n      next(new HttpException(401, 'Token身份无效!'));\n    }\n\n    try {\n      // 解密payload，获取用户名和ID\n      let payload = jwt.verify(token.split(' ')[1], SECRET_KEY) as User;\n      req.user = {\n        username: payload.username,\n        email: payload.email,\n        id: payload.id,\n      } as User;\n      next();\n    } catch (err) {\n      next(new HttpException(401, 'Token身份无效!'));\n    }\n  };\n}\n"],"names":["jwtUnlessPath","jwtTokenParse","req","res","next","find","item","url","token","header","HttpException","payload","jwt","verify","split","SECRET_KEY","user","username","email","id","err"],"mappings":"AAAA;;;;;;AAAgB,IAAA,aAAc,kCAAd,cAAc,EAAA;AACH,IAAA,OAAS,WAAT,WAAS,CAAA;AAGN,IAAA,cAA4B,WAA5B,6BAA4B,CAAA;;;;;;AAInD,MAAMA,aAAa,GAAG;IAAC,QAAQ;IAAE,SAAS;CAAC,AAAC;QAAtCA,aAAa,GAAbA,aAAa;AAKX,oBAAY;IACzB,OAAO,eAAeC,aAAa,CAACC,GAAoB,EAAEC,GAAa,EAAEC,IAAkB,EAAE;QAE3F,IAAIJ,aAAa,CAACK,IAAI,CAACC,CAAAA,IAAI,GAAIA,IAAI,KAAKJ,GAAG,CAACK,GAAG;QAAA,CAAC,EAAE;YAChD,MAAMH,IAAI,EAAE,CAAC;YACb,OAAO,KAAK,CAAC;SACd;QAGD,MAAMI,KAAK,GAAGN,GAAG,CAACO,MAAM,CAAC,eAAe,CAAC,AAAC;QAC1C,IAAI,CAACD,KAAK,EAAE;YACVJ,IAAI,CAAC,IAAIM,cAAa,cAAA,CAAC,GAAG,EAAE,oBAAY,CAAS,CAAC,CAAC;SAC5C;QAET,IAAI;YAEF,IAAIC,OAAO,GAAGC,aAAG,QAAA,CAACC,MAAM,CAACL,KAAK,CAACM,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,EAAEC,OAAU,WAAA,CAAC,AAAQ,AAAC;YAClEb,GAAG,CAACc,IAAI,GAAG;gBACTC,QAAQ,EAAEN,OAAO,CAACM,QAAQ;gBAC1BC,KAAK,EAAEP,OAAO,CAACO,KAAK;gBACpBC,EAAE,EAAER,OAAO,CAACQ,EAAE;aACf,AAAQ,CAAC;YACVf,IAAI,EAAE,CAAC;SACR,CAAC,OAAOgB,GAAG,EAAE;YACZhB,IAAI,CAAC,IAAIM,cAAa,cAAA,CAAC,GAAG,EAAE,oBAAY,CAAC,CAAC,CAAC;SAC5C;KACF,CAAC;CACH"}